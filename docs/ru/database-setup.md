# Настройка базы данных и взаимодействие с контентом

## Обзор системы

В данной CMS платформе используется Prisma ORM для взаимодействия с базой данных. По умолчанию используется SQLite для разработки, но система поддерживает и другие базы данных (PostgreSQL, MySQL и т.д.).

## Почему контент не сохраняется

В текущей реализации, когда вы работаете в браузере через Tempo, используется мок-версия Prisma клиента (`src/lib/services/database.ts`), которая имитирует взаимодействие с базой данных, но на самом деле не сохраняет данные. Это сделано потому, что Prisma не может работать напрямую в браузере.

## Настройка локальной разработки

Чтобы настроить проект для локальной разработки с реальной базой данных:

### 1. Клонирование и установка проекта

```bash
# Клонировать репозиторий
git clone <url-репозитория>
cd <название-проекта>

# Установить зависимости
npm install
```

### 2. Настройка базы данных

По умолчанию проект использует SQLite. Файл `.env` уже содержит строку подключения:

```
DATABASE_URL="file:./dev.db"
```

### 3. Инициализация базы данных

Выполните следующие команды для создания и инициализации базы данных:

```bash
# Создание миграций Prisma (если они еще не созданы)
npx prisma migrate dev --name init

# Генерация Prisma клиента
npx prisma generate
```

### 4. Запуск проекта

```bash
npm run dev
```

## Как работает сохранение контента

Процесс сохранения контента происходит следующим образом:

1. Пользователь заполняет форму в компоненте `ContentEditor` (`src/components/content/ContentEditor.tsx`)
2. При нажатии кнопки "Save Content" вызывается функция `onSubmit`
3. Функция `onSubmit` выполняет следующие действия:
   - Генерирует событие `content:beforeCreate` или `content:beforeUpdate`
   - Вызывает метод `ContentDatabase.saveContent()` для сохранения основного контента
   - Если есть SEO метаданные, вызывает `ContentDatabase.saveContentMetadata()`
   - Генерирует событие `content:afterCreate` или `content:afterUpdate`

## Структура базы данных для контента

В базе данных контент хранится в следующих таблицах:

1. `Content` - основная информация о контенте (заголовок, слаг, тип, статус, содержимое)
2. `ContentMetadata` - метаданные контента (например, SEO данные)

Схема определена в файле `prisma/schema.prisma`.

## Модификация для работы с другими базами данных

Если вы хотите использовать другую базу данных (например, PostgreSQL или MySQL):

1. Измените строку подключения в файле `.env`:

```
# Для PostgreSQL
DATABASE_URL="postgresql://username:password@localhost:5432/mydb?schema=public"

# Для MySQL
DATABASE_URL="mysql://username:password@localhost:3306/mydb"
```

2. Обновите провайдер в `prisma/schema.prisma`:

```prisma
datasource db {
  provider = "postgresql" // или "mysql"
  url      = env("DATABASE_URL")
}
```

3. Создайте новую миграцию:

```bash
npx prisma migrate dev --name init
```

## Отладка проблем с базой данных

Если у вас возникают проблемы с сохранением контента:

1. Проверьте консоль на наличие ошибок
2. Убедитесь, что база данных создана и миграции применены
3. Используйте Prisma Studio для просмотра содержимого базы данных:

```bash
npx prisma studio
```

4. Проверьте, что файл базы данных SQLite (`dev.db`) создан в корневой директории проекта

## Взаимодействие с плагинами

Плагины, такие как SEO Toolkit, могут взаимодействовать с контентом через систему событий:

1. Плагин подписывается на события `content:beforeCreate`, `content:beforeUpdate` и т.д.
2. Когда происходит соответствующее действие, плагин получает данные и может их модифицировать
3. Плагин может сохранять свои метаданные через `ContentDatabase.saveContentMetadata()`

Пример этого взаимодействия можно увидеть в файле `plugins/seo-toolkit/index.js`.
